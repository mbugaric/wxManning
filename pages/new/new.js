"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var hotOrNew = 'new';
var common_1 = require("../../utils/common");
var app = getApp();
Page({
    data: {
        motto: common_1.getMottoForTab(hotOrNew),
        userInfo: {},
        bookData: {},
        sortedMEAPdata: [],
        sortedPublishedData: [],
        hasUserInfo: false,
        currentTab: 0,
        canIUse: wx.canIUse('button.open-type.getUserInfo'),
    },
    bindViewTap: function () {
        console.log(app.globalData);
    },
    selectTab: function (event) {
        if (event && event.currentTarget && event.currentTarget.dataset) {
            var newTab = Number(event.currentTarget.dataset.tab);
            if (!isNaN(newTab) && newTab != this.data.currentTab) {
                this.setData({
                    currentTab: newTab,
                });
            }
        }
    },
    onLoad: function () {
        this.setUserInfoData();
        this.setBookData();
    },
    setBookData: function () {
        var _this = this;
        if (app.globalData.bookData) {
            this.setData({
                bookData: app.globalData.bookData,
            }, function () {
                _this.prepareInitialSortedMEAPandPublishedBooks();
            });
        }
        else {
            app.bookDataReadyCallback = function (res) {
                _this.setData({
                    bookData: res,
                }, function () {
                    _this.prepareInitialSortedMEAPandPublishedBooks();
                });
            };
        }
    },
    onShow: function () {
        console.log(hotOrNew, app.globalData.bookDataObtained, "sortedMEAPdata", this.data.sortedMEAPdata, "!!!");
        console.log(hotOrNew, app.globalData.bookDataObtained, "sortedPublishedData", this.data.sortedPublishedData, "!!!");
    },
    prepareInitialSortedMEAPandPublishedBooks: function () {
        if (this.data.bookData) {
            if (this.data.bookData.meaps && this.data.bookData.meaps.length) {
                var sortingFunction = common_1.getSortingFunctionForTab(hotOrNew);
                var sortedMEAPdata = this.data.bookData.meaps.map(function (it) { return common_1.addAuthorIfMissing(it); }).sort(sortingFunction);
                this.setData({
                    sortedMEAPdata: sortedMEAPdata
                });
            }
            if (this.data.bookData.published && this.data.bookData.published.length) {
                var sortingFunction = common_1.getSortingFunctionForTab(hotOrNew);
                var sortedPublishedData = this.data.bookData.published.map(function (it) { return common_1.addAuthorIfMissing(it); }).sort(sortingFunction);
                this.setData({
                    sortedPublishedData: sortedPublishedData
                });
            }
        }
    },
    setUserInfoData: function () {
        var _this = this;
        if (app.globalData.userInfo) {
            this.setData({
                userInfo: app.globalData.userInfo,
                hasUserInfo: true,
            });
        }
        else if (this.data.canIUse) {
            app.userInfoReadyCallback = function (res) {
                _this.setData({
                    userInfo: res,
                    hasUserInfo: true
                });
            };
        }
        else {
            wx.getUserInfo({
                success: function (res) {
                    app.globalData.userInfo = res.userInfo;
                    _this.setData({
                        userInfo: res.userInfo,
                        hasUserInfo: true
                    });
                }
            });
        }
    },
    getUserInfo: function (e) {
        console.log(e);
        app.globalData.userInfo = e.detail.userInfo;
        this.setData({
            userInfo: e.detail.userInfo,
            hasUserInfo: true
        });
    }
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmV3LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsibmV3LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsSUFBTSxRQUFRLEdBQUcsS0FBSyxDQUFDO0FBU3ZCLDZDQUk0QjtBQUU1QixJQUFNLEdBQUcsR0FBRyxNQUFNLEVBQVUsQ0FBQztBQUU3QixJQUFJLENBQUM7SUFDSCxJQUFJLEVBQUU7UUFDSixLQUFLLEVBQUUsdUJBQWMsQ0FBQyxRQUFRLENBQVc7UUFDekMsUUFBUSxFQUFFLEVBQUU7UUFDWixRQUFRLEVBQUUsRUFBZTtRQUN6QixjQUFjLEVBQUUsRUFBYztRQUM5QixtQkFBbUIsRUFBRSxFQUFrQjtRQUN2QyxXQUFXLEVBQUUsS0FBZ0I7UUFDN0IsVUFBVSxFQUFFLENBQVc7UUFDdkIsT0FBTyxFQUFFLEVBQUUsQ0FBQyxPQUFPLENBQUMsOEJBQThCLENBQUM7S0FDcEQ7SUFFRCxXQUFXO1FBQ1QsT0FBTyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsVUFBVSxDQUFDLENBQUE7SUFDN0IsQ0FBQztJQUVELFNBQVMsWUFBQyxLQUFVO1FBQ2xCLElBQUksS0FBSyxJQUFJLEtBQUssQ0FBQyxhQUFhLElBQUksS0FBSyxDQUFDLGFBQWEsQ0FBQyxPQUFPLEVBQUU7WUFDL0QsSUFBTSxNQUFNLEdBQUcsTUFBTSxDQUFDLEtBQUssQ0FBQyxhQUFhLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQ3ZELElBQUcsQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLElBQUksTUFBTSxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFDO2dCQUNsRCxJQUFJLENBQUMsT0FBUSxDQUFDO29CQUNaLFVBQVUsRUFBRSxNQUFNO2lCQUNuQixDQUFDLENBQUE7YUFDSDtTQUNGO0lBQ0gsQ0FBQztJQUVELE1BQU07UUFDSixJQUFJLENBQUMsZUFBZSxFQUFFLENBQUM7UUFDdkIsSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO0lBQ3JCLENBQUM7SUFFRCxXQUFXO1FBQVgsaUJBZ0JDO1FBZkMsSUFBSSxHQUFHLENBQUMsVUFBVSxDQUFDLFFBQVEsRUFBRTtZQUMzQixJQUFJLENBQUMsT0FBUSxDQUFDO2dCQUNaLFFBQVEsRUFBRSxHQUFHLENBQUMsVUFBVSxDQUFDLFFBQVE7YUFDbEMsRUFBRTtnQkFDRCxLQUFJLENBQUMseUNBQXlDLEVBQUUsQ0FBQTtZQUNsRCxDQUFDLENBQUMsQ0FBQTtTQUNIO2FBQU07WUFDTCxHQUFHLENBQUMscUJBQXFCLEdBQUcsVUFBQyxHQUFRO2dCQUNuQyxLQUFJLENBQUMsT0FBUSxDQUFDO29CQUNaLFFBQVEsRUFBRSxHQUFHO2lCQUNkLEVBQUU7b0JBQ0QsS0FBSSxDQUFDLHlDQUF5QyxFQUFFLENBQUE7Z0JBQ2xELENBQUMsQ0FBQyxDQUFBO1lBQ0osQ0FBQyxDQUFBO1NBQ0Y7SUFDSCxDQUFDO0lBRUQsTUFBTSxFQUFFO1FBQ04sT0FBTyxDQUFDLEdBQUcsQ0FBQyxRQUFRLEVBQUUsR0FBRyxDQUFDLFVBQVUsQ0FBQyxnQkFBZ0IsRUFBRSxnQkFBZ0IsRUFBRSxJQUFJLENBQUMsSUFBSSxDQUFDLGNBQWMsRUFBRSxLQUFLLENBQUMsQ0FBQTtRQUN6RyxPQUFPLENBQUMsR0FBRyxDQUFDLFFBQVEsRUFBRSxHQUFHLENBQUMsVUFBVSxDQUFDLGdCQUFnQixFQUFFLHFCQUFxQixFQUFFLElBQUksQ0FBQyxJQUFJLENBQUMsbUJBQW1CLEVBQUUsS0FBSyxDQUFDLENBQUE7SUFDckgsQ0FBQztJQUVELHlDQUF5QztRQUN2QyxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFO1lBRXRCLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsS0FBSyxJQUFJLElBQUksQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxNQUFNLEVBQUU7Z0JBQy9ELElBQU0sZUFBZSxHQUFHLGlDQUF3QixDQUFDLFFBQVEsQ0FBQyxDQUFDO2dCQUMzRCxJQUFNLGNBQWMsR0FBVyxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLFVBQUMsRUFBTyxJQUFLLE9BQUEsMkJBQWtCLENBQUMsRUFBRSxDQUFDLEVBQXRCLENBQXNCLENBQUMsQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLENBQUM7Z0JBQ3ZILElBQUksQ0FBQyxPQUFRLENBQUM7b0JBQ1osY0FBYyxFQUFFLGNBQWM7aUJBQy9CLENBQUMsQ0FBQTthQUNIO1lBRUQsSUFBSSxJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxTQUFTLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLE1BQU0sRUFBRTtnQkFDdkUsSUFBTSxlQUFlLEdBQUcsaUNBQXdCLENBQUMsUUFBUSxDQUFDLENBQUM7Z0JBQzNELElBQU0sbUJBQW1CLEdBQWUsSUFBSSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxVQUFDLEVBQU8sSUFBSyxPQUFBLDJCQUFrQixDQUFDLEVBQUUsQ0FBQyxFQUF0QixDQUFzQixDQUFDLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxDQUFDO2dCQUNwSSxJQUFJLENBQUMsT0FBUSxDQUFDO29CQUNaLG1CQUFtQixFQUFFLG1CQUFtQjtpQkFDekMsQ0FBQyxDQUFBO2FBQ0g7U0FDRjtJQUNILENBQUM7SUFFRCxlQUFlO1FBQWYsaUJBd0JDO1FBdkJDLElBQUksR0FBRyxDQUFDLFVBQVUsQ0FBQyxRQUFRLEVBQUU7WUFDM0IsSUFBSSxDQUFDLE9BQVEsQ0FBQztnQkFDWixRQUFRLEVBQUUsR0FBRyxDQUFDLFVBQVUsQ0FBQyxRQUFRO2dCQUNqQyxXQUFXLEVBQUUsSUFBSTthQUNsQixDQUFDLENBQUE7U0FDSDthQUFNLElBQUksSUFBSSxDQUFDLElBQUksQ0FBQyxPQUFPLEVBQUU7WUFDNUIsR0FBRyxDQUFDLHFCQUFxQixHQUFHLFVBQUMsR0FBUTtnQkFDbkMsS0FBSSxDQUFDLE9BQVEsQ0FBQztvQkFDWixRQUFRLEVBQUUsR0FBRztvQkFDYixXQUFXLEVBQUUsSUFBSTtpQkFDbEIsQ0FBQyxDQUFBO1lBQ0osQ0FBQyxDQUFBO1NBQ0Y7YUFBTTtZQUNMLEVBQUUsQ0FBQyxXQUFXLENBQUM7Z0JBQ2IsT0FBTyxFQUFFLFVBQUEsR0FBRztvQkFDVixHQUFHLENBQUMsVUFBVSxDQUFDLFFBQVEsR0FBRyxHQUFHLENBQUMsUUFBUSxDQUFBO29CQUN0QyxLQUFJLENBQUMsT0FBUSxDQUFDO3dCQUNaLFFBQVEsRUFBRSxHQUFHLENBQUMsUUFBUTt3QkFDdEIsV0FBVyxFQUFFLElBQUk7cUJBQ2xCLENBQUMsQ0FBQTtnQkFDSixDQUFDO2FBQ0YsQ0FBQyxDQUFBO1NBQ0g7SUFDSCxDQUFDO0lBRUQsV0FBVyxZQUFDLENBQU07UUFDaEIsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQTtRQUNkLEdBQUcsQ0FBQyxVQUFVLENBQUMsUUFBUSxHQUFHLENBQUMsQ0FBQyxNQUFNLENBQUMsUUFBUSxDQUFBO1FBQzNDLElBQUksQ0FBQyxPQUFRLENBQUM7WUFDWixRQUFRLEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxRQUFRO1lBQzNCLFdBQVcsRUFBRSxJQUFJO1NBQ2xCLENBQUMsQ0FBQTtJQUNKLENBQUM7Q0FDRixDQUFDLENBQUEiLCJzb3VyY2VzQ29udGVudCI6WyJjb25zdCBob3RPck5ldyA9ICduZXcnO1xuXG5pbXBvcnQgeyBJTXlBcHAgfSBmcm9tICcuLi8uLi9hcHAnO1xuaW1wb3J0IHtcbiAgSUJvb2tEYXRhLFxuICBJTUVBUHMsXG4gIElQdWJsaXNoZWRcbn0gZnJvbSAnLi4vLi4vbW9kZWxzL21vZGVscyc7XG5cbmltcG9ydCB7XG4gIGdldFNvcnRpbmdGdW5jdGlvbkZvclRhYixcbiAgZ2V0TW90dG9Gb3JUYWIsXG4gIGFkZEF1dGhvcklmTWlzc2luZyxcbn0gZnJvbSAnLi4vLi4vdXRpbHMvY29tbW9uJztcblxuY29uc3QgYXBwID0gZ2V0QXBwPElNeUFwcD4oKTtcblxuUGFnZSh7XG4gIGRhdGE6IHtcbiAgICBtb3R0bzogZ2V0TW90dG9Gb3JUYWIoaG90T3JOZXcpIGFzIHN0cmluZyxcbiAgICB1c2VySW5mbzoge30sXG4gICAgYm9va0RhdGE6IHt9IGFzIElCb29rRGF0YSxcbiAgICBzb3J0ZWRNRUFQZGF0YTogW10gYXMgSU1FQVBzW10sXG4gICAgc29ydGVkUHVibGlzaGVkRGF0YTogW10gYXMgSVB1Ymxpc2hlZFtdLFxuICAgIGhhc1VzZXJJbmZvOiBmYWxzZSBhcyBib29sZWFuLFxuICAgIGN1cnJlbnRUYWI6IDAgYXMgbnVtYmVyLFxuICAgIGNhbklVc2U6IHd4LmNhbklVc2UoJ2J1dHRvbi5vcGVuLXR5cGUuZ2V0VXNlckluZm8nKSxcbiAgfSxcblxuICBiaW5kVmlld1RhcCgpIHtcbiAgICBjb25zb2xlLmxvZyhhcHAuZ2xvYmFsRGF0YSlcbiAgfSxcblxuICBzZWxlY3RUYWIoZXZlbnQ6IGFueSkge1xuICAgIGlmIChldmVudCAmJiBldmVudC5jdXJyZW50VGFyZ2V0ICYmIGV2ZW50LmN1cnJlbnRUYXJnZXQuZGF0YXNldCkge1xuICAgICAgY29uc3QgbmV3VGFiID0gTnVtYmVyKGV2ZW50LmN1cnJlbnRUYXJnZXQuZGF0YXNldC50YWIpO1xuICAgICAgaWYoIWlzTmFOKG5ld1RhYikgJiYgbmV3VGFiICE9IHRoaXMuZGF0YS5jdXJyZW50VGFiKXtcbiAgICAgICAgdGhpcy5zZXREYXRhISh7XG4gICAgICAgICAgY3VycmVudFRhYjogbmV3VGFiLFxuICAgICAgICB9KVxuICAgICAgfVxuICAgIH1cbiAgfSxcblxuICBvbkxvYWQoKSB7XG4gICAgdGhpcy5zZXRVc2VySW5mb0RhdGEoKTtcbiAgICB0aGlzLnNldEJvb2tEYXRhKCk7XG4gIH0sXG5cbiAgc2V0Qm9va0RhdGEoKSB7XG4gICAgaWYgKGFwcC5nbG9iYWxEYXRhLmJvb2tEYXRhKSB7XG4gICAgICB0aGlzLnNldERhdGEhKHtcbiAgICAgICAgYm9va0RhdGE6IGFwcC5nbG9iYWxEYXRhLmJvb2tEYXRhLFxuICAgICAgfSwgKCkgPT4ge1xuICAgICAgICB0aGlzLnByZXBhcmVJbml0aWFsU29ydGVkTUVBUGFuZFB1Ymxpc2hlZEJvb2tzKClcbiAgICAgIH0pXG4gICAgfSBlbHNlIHtcbiAgICAgIGFwcC5ib29rRGF0YVJlYWR5Q2FsbGJhY2sgPSAocmVzOiBhbnkpID0+IHtcbiAgICAgICAgdGhpcy5zZXREYXRhISh7XG4gICAgICAgICAgYm9va0RhdGE6IHJlcyxcbiAgICAgICAgfSwgKCkgPT4ge1xuICAgICAgICAgIHRoaXMucHJlcGFyZUluaXRpYWxTb3J0ZWRNRUFQYW5kUHVibGlzaGVkQm9va3MoKVxuICAgICAgICB9KVxuICAgICAgfVxuICAgIH1cbiAgfSxcblxuICBvblNob3c6IGZ1bmN0aW9uICgpIHtcbiAgICBjb25zb2xlLmxvZyhob3RPck5ldywgYXBwLmdsb2JhbERhdGEuYm9va0RhdGFPYnRhaW5lZCwgXCJzb3J0ZWRNRUFQZGF0YVwiLCB0aGlzLmRhdGEuc29ydGVkTUVBUGRhdGEsIFwiISEhXCIpXG4gICAgY29uc29sZS5sb2coaG90T3JOZXcsIGFwcC5nbG9iYWxEYXRhLmJvb2tEYXRhT2J0YWluZWQsIFwic29ydGVkUHVibGlzaGVkRGF0YVwiLCB0aGlzLmRhdGEuc29ydGVkUHVibGlzaGVkRGF0YSwgXCIhISFcIilcbiAgfSxcblxuICBwcmVwYXJlSW5pdGlhbFNvcnRlZE1FQVBhbmRQdWJsaXNoZWRCb29rcygpIHtcbiAgICBpZiAodGhpcy5kYXRhLmJvb2tEYXRhKSB7XG4gICAgICAvL01FQVAgZGF0YVxuICAgICAgaWYgKHRoaXMuZGF0YS5ib29rRGF0YS5tZWFwcyAmJiB0aGlzLmRhdGEuYm9va0RhdGEubWVhcHMubGVuZ3RoKSB7XG4gICAgICAgIGNvbnN0IHNvcnRpbmdGdW5jdGlvbiA9IGdldFNvcnRpbmdGdW5jdGlvbkZvclRhYihob3RPck5ldyk7XG4gICAgICAgIGNvbnN0IHNvcnRlZE1FQVBkYXRhOiBJTUVBUHMgPSB0aGlzLmRhdGEuYm9va0RhdGEubWVhcHMubWFwKChpdDogYW55KSA9PiBhZGRBdXRob3JJZk1pc3NpbmcoaXQpKS5zb3J0KHNvcnRpbmdGdW5jdGlvbik7XG4gICAgICAgIHRoaXMuc2V0RGF0YSEoe1xuICAgICAgICAgIHNvcnRlZE1FQVBkYXRhOiBzb3J0ZWRNRUFQZGF0YVxuICAgICAgICB9KVxuICAgICAgfVxuICAgICAgLy9QdWJsaXNoZWQgZGF0YVxuICAgICAgaWYgKHRoaXMuZGF0YS5ib29rRGF0YS5wdWJsaXNoZWQgJiYgdGhpcy5kYXRhLmJvb2tEYXRhLnB1Ymxpc2hlZC5sZW5ndGgpIHtcbiAgICAgICAgY29uc3Qgc29ydGluZ0Z1bmN0aW9uID0gZ2V0U29ydGluZ0Z1bmN0aW9uRm9yVGFiKGhvdE9yTmV3KTtcbiAgICAgICAgY29uc3Qgc29ydGVkUHVibGlzaGVkRGF0YTogSVB1Ymxpc2hlZCA9IHRoaXMuZGF0YS5ib29rRGF0YS5wdWJsaXNoZWQubWFwKChpdDogYW55KSA9PiBhZGRBdXRob3JJZk1pc3NpbmcoaXQpKS5zb3J0KHNvcnRpbmdGdW5jdGlvbik7XG4gICAgICAgIHRoaXMuc2V0RGF0YSEoe1xuICAgICAgICAgIHNvcnRlZFB1Ymxpc2hlZERhdGE6IHNvcnRlZFB1Ymxpc2hlZERhdGFcbiAgICAgICAgfSlcbiAgICAgIH1cbiAgICB9XG4gIH0sXG5cbiAgc2V0VXNlckluZm9EYXRhKCkge1xuICAgIGlmIChhcHAuZ2xvYmFsRGF0YS51c2VySW5mbykge1xuICAgICAgdGhpcy5zZXREYXRhISh7XG4gICAgICAgIHVzZXJJbmZvOiBhcHAuZ2xvYmFsRGF0YS51c2VySW5mbyxcbiAgICAgICAgaGFzVXNlckluZm86IHRydWUsXG4gICAgICB9KVxuICAgIH0gZWxzZSBpZiAodGhpcy5kYXRhLmNhbklVc2UpIHtcbiAgICAgIGFwcC51c2VySW5mb1JlYWR5Q2FsbGJhY2sgPSAocmVzOiBhbnkpID0+IHtcbiAgICAgICAgdGhpcy5zZXREYXRhISh7XG4gICAgICAgICAgdXNlckluZm86IHJlcyxcbiAgICAgICAgICBoYXNVc2VySW5mbzogdHJ1ZVxuICAgICAgICB9KVxuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICB3eC5nZXRVc2VySW5mbyh7XG4gICAgICAgIHN1Y2Nlc3M6IHJlcyA9PiB7XG4gICAgICAgICAgYXBwLmdsb2JhbERhdGEudXNlckluZm8gPSByZXMudXNlckluZm9cbiAgICAgICAgICB0aGlzLnNldERhdGEhKHtcbiAgICAgICAgICAgIHVzZXJJbmZvOiByZXMudXNlckluZm8sXG4gICAgICAgICAgICBoYXNVc2VySW5mbzogdHJ1ZVxuICAgICAgICAgIH0pXG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgfVxuICB9LFxuXG4gIGdldFVzZXJJbmZvKGU6IGFueSkge1xuICAgIGNvbnNvbGUubG9nKGUpXG4gICAgYXBwLmdsb2JhbERhdGEudXNlckluZm8gPSBlLmRldGFpbC51c2VySW5mb1xuICAgIHRoaXMuc2V0RGF0YSEoe1xuICAgICAgdXNlckluZm86IGUuZGV0YWlsLnVzZXJJbmZvLFxuICAgICAgaGFzVXNlckluZm86IHRydWVcbiAgICB9KVxuICB9XG59KVxuIl19